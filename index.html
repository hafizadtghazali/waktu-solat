<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waktu Solat Web App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Waktu Solat</h1>
            <div class="date-display" id="current-date">Kemaskini tarikh...</div>
        </header>
        
        <div class="location-info">
            <div class="location-details">
                <h2 id="location-name">Jejak...</h2>
                <p id="location-coords">Mencari lokasi...</p>
                <div class="location-options">
                    <button class="location-btn" id="btn-precise">Geo-Lokasi</button>
                    <button class="location-btn active" id="btn-estimated">Lokasi Anggaran</button>
                </div>
            </div>
            <button class="refresh-btn" id="refresh-btn">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        
        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Kemaskini waktu solat...</p>
        </div>
        
        <div id="error-message" class="error" style="display: none;">
            <p>Tidak dapat memuatkan waktu solat. Sila cuba lagi kemudian.</p>
        </div>
        
        <div class="prayer-times" id="prayer-times" style="display: none;">
            <!-- Prayer times will be inserted here -->
        </div>
        
        <div class="next-prayer" id="next-prayer" style="display: none;">
            <h3>Solat seterusnya</h3>
            <div class="next-prayer-name" id="next-prayer-name">Kemaskini...</div>
            <div class="countdown" id="countdown">--:--:--</div>
        </div>
        
        <footer>
            <p>Waktu Solat oleh JAKIM e-solat API</p>
        </footer>
    </div>

    <script>
        // DOM Elements
        const currentDateEl = document.getElementById('current-date');
        const locationNameEl = document.getElementById('location-name');
        const locationCoordsEl = document.getElementById('location-coords');
        const refreshBtn = document.getElementById('refresh-btn');
        const loadingEl = document.getElementById('loading');
        const errorMessageEl = document.getElementById('error-message');
        const prayerTimesEl = document.getElementById('prayer-times');
        const nextPrayerEl = document.getElementById('next-prayer');
        const nextPrayerNameEl = document.getElementById('next-prayer-name');
        const countdownEl = document.getElementById('countdown');
        const btnPrecise = document.getElementById('btn-precise');
        const btnEstimated = document.getElementById('btn-estimated');
        
        // Prayer names and icons
        const prayers = [
            { name: 'Subuh', icon: 'fas fa-sun' },
            { name: 'Syuruk', icon: 'fas fa-sun' },
            { name: 'Zohor', icon: 'fas fa-sun' },
            { name: 'Asar', icon: 'fas fa-sun' },
            { name: 'Maghrib', icon: 'fas fa-moon' },
            { name: 'Isyak', icon: 'fas fa-moon' }
        ];
        
        // Malaysian zones data (simplified)
        const malaysianZones = [
            { name: 'Kuala Lumpur', code: 'wlp-0', lat: 3.1390, lng: 101.6869 },
            { name: 'Penang', code: 'png-1', lat: 5.4141, lng: 100.3288 },
            { name: 'Johor Bahru', code: 'jhr-1', lat: 1.4927, lng: 103.7414 },
            { name: 'Kota Kinabalu', code: 'sbh-1', lat: 5.9804, lng: 116.0735 },
            { name: 'Kuching', code: 'swk-1', lat: 1.5535, lng: 110.3593 },
            { name: 'Ipoh', code: 'prk-1', lat: 4.5975, lng: 101.0901 },
            { name: 'Shah Alam', code: 'sgr-1', lat: 3.0733, lng: 101.5185 },
            { name: 'Kuantan', code: 'phg-1', lat: 3.8167, lng: 103.3333 }
        ];
        
        // Global variables
        let userLocation = null;
        let prayerTimesData = null;
        let countdownInterval = null;
        let usePreciseLocation = false;
        
        // Initialize the app
        function init() {
            updateCurrentDate();
            getEstimatedLocation();
            
            // Set up event listeners
            refreshBtn.addEventListener('click', function() {
                if (usePreciseLocation) {
                    getPreciseLocation();
                } else {
                    getEstimatedLocation();
                }
            });
            
            btnPrecise.addEventListener('click', function() {
                usePreciseLocation = true;
                btnPrecise.classList.add('active');
                btnEstimated.classList.remove('active');
                getPreciseLocation();
            });
            
            btnEstimated.addEventListener('click', function() {
                usePreciseLocation = false;
                btnEstimated.classList.add('active');
                btnPrecise.classList.remove('active');
                getEstimatedLocation();
            });
            
            // Update date every minute
            setInterval(updateCurrentDate, 60000);
        }
        
        // Update current date display
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            currentDateEl.textContent = now.toLocaleDateString('en-MY', options);
        }
        
        // Get precise user location
        function getPreciseLocation() {
            loadingEl.style.display = 'block';
            errorMessageEl.style.display = 'none';
            prayerTimesEl.style.display = 'none';
            nextPrayerEl.style.display = 'none';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        userLocation = { lat, lng };
                        
                        locationCoordsEl.textContent = `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
                        getLocationName(lat, lng);
                        getPrayerTimes(lat, lng);
                    },
                    error => {
                        console.error('Error getting precise location:', error);
                        // Fallback to estimated location
                        getEstimatedLocation();
                    }
                );
            } else {
                // Fallback to estimated location
                getEstimatedLocation();
            }
        }
        
        // Get estimated location based on IP
        function getEstimatedLocation() {
            loadingEl.style.display = 'block';
            errorMessageEl.style.display = 'none';
            prayerTimesEl.style.display = 'none';
            nextPrayerEl.style.display = 'none';
            
            // For demo purposes, we'll randomly select a Malaysian city
            // In a real app, you would use an IP geolocation service
            const randomZone = malaysianZones[Math.floor(Math.random() * malaysianZones.length)];
            userLocation = { lat: randomZone.lat, lng: randomZone.lng };
            
            locationNameEl.textContent = randomZone.name;
            locationCoordsEl.textContent = `Lokasi Anggaran`;
            getPrayerTimes(randomZone.lat, randomZone.lng);
        }
        
        // Get location name from coordinates
        function getLocationName(lat, lng) {
            // Using Nominatim OpenStreetMap for reverse geocoding
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.address) {
                        const address = data.address;
                        let locationName = '';
                        
                        if (address.city) {
                            locationName = address.city;
                        } else if (address.town) {
                            locationName = address.town;
                        } else if (address.village) {
                            locationName = address.village;
                        } else if (address.county) {
                            locationName = address.county;
                        } else if (address.state) {
                            locationName = address.state;
                        }
                        
                        locationNameEl.textContent = locationName || 'Unknown Location';
                    } else {
                        locationNameEl.textContent = 'Unknown Location';
                    }
                })
                .catch(error => {
                    console.error('Error getting location name:', error);
                    locationNameEl.textContent = 'Unknown Location';
                });
        }
        
        // Get prayer times from API
        function getPrayerTimes(lat, lng) {
            // Using Aladhan API as JAKIM API requires zone codes
            const date = new Date();
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            
            fetch(`https://api.aladhan.com/v1/timings/${day}-${month}-${year}?latitude=${lat}&longitude=${lng}&method=8`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        prayerTimesData = data.data.timings;
                        displayPrayerTimes(prayerTimesData);
                        startCountdown(prayerTimesData);
                    } else {
                        throw new Error('Failed to fetch prayer times');
                    }
                })
                .catch(error => {
                    console.error('Error fetching prayer times:', error);
                    loadingEl.style.display = 'none';
                    errorMessageEl.style.display = 'block';
                });
        }
        
        // Display prayer times
        function displayPrayerTimes(timings) {
            prayerTimesEl.innerHTML = '';
            
            prayers.forEach(prayer => {
                const prayerTime = timings[prayer.name === 'Subuh' ? 'Fajr' : 
                                          prayer.name === 'Syuruk' ? 'Sunrise' : 
                                          prayer.name === 'Zohor' ? 'Dhuhr' : 
                                          prayer.name === 'Asar' ? 'Asr' : 
                                          prayer.name === 'Maghrib' ? 'Maghrib' : 
                                          'Isha'];
                
                const prayerCard = document.createElement('div');
                prayerCard.className = 'prayer-card';
                
                prayerCard.innerHTML = `
                    <div class="prayer-name">
                        <i class="${prayer.icon}"></i>
                        <span>${prayer.name}</span>
                    </div>
                    <div class="prayer-time">${prayerTime}</div>
                `;
                
                prayerTimesEl.appendChild(prayerCard);
            });
            
            loadingEl.style.display = 'none';
            prayerTimesEl.style.display = 'flex';
            nextPrayerEl.style.display = 'block';
        }
        
        // Start countdown to next prayer
        function startCountdown(timings) {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            countdownInterval = setInterval(() => {
                const now = new Date();
                const currentTime = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
                
                // Convert prayer times to seconds since midnight
                const prayerTimesInSeconds = {
                    'Fajr': timeToSeconds(timings.Fajr),
                    'Sunrise': timeToSeconds(timings.Sunrise),
                    'Dhuhr': timeToSeconds(timings.Dhuhr),
                    'Asr': timeToSeconds(timings.Asr),
                    'Maghrib': timeToSeconds(timings.Maghrib),
                    'Isha': timeToSeconds(timings.Isha)
                };
                
                // Find next prayer
                let nextPrayer = null;
                let nextPrayerTime = null;
                
                for (const [prayer, timeInSeconds] of Object.entries(prayerTimesInSeconds)) {
                    if (timeInSeconds > currentTime) {
                        nextPrayer = prayer;
                        nextPrayerTime = timeInSeconds;
                        break;
                    }
                }
                
                // If no prayer found for today, use first prayer of next day
                if (!nextPrayer) {
                    nextPrayer = 'Fajr';
                    nextPrayerTime = prayerTimesInSeconds.Fajr + 24 * 3600;
                }
                
                // Calculate time difference
                const timeDiff = nextPrayerTime - currentTime;
                
                // Update display
                const prayerNames = {
                    'Fajr': 'Subuh',
                    'Sunrise': 'Syuruk',
                    'Dhuhr': 'Zohor',
                    'Asr': 'Asar',
                    'Maghrib': 'Maghrib',
                    'Isha': 'Isyak'
                };
                
                nextPrayerNameEl.textContent = prayerNames[nextPrayer];
                countdownEl.textContent = formatTime(timeDiff);
                
                // Update active prayer card
                updateActivePrayerCard(prayerNames[nextPrayer]);
            }, 1000);
        }
        
        // Convert time string to seconds since midnight
        function timeToSeconds(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 3600 + minutes * 60;
        }
        
        // Format seconds to HH:MM:SS
        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Update active prayer card
        function updateActivePrayerCard(nextPrayerName) {
            const prayerCards = document.querySelectorAll('.prayer-card');
            
            prayerCards.forEach(card => {
                const prayerName = card.querySelector('.prayer-name span').textContent;
                
                if (prayerName === nextPrayerName) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });
        }
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
